#!/usr/bin/env bash
set -e

SESSION_NAME="xtide86"
TMUX_CONF="$HOME/.tmux.conf"
IS_NO_COLOR=false

# === Flag Parsing ===
case "$1" in
  --no-color|-nc)
    IS_NO_COLOR=true
    echo "[XTide86] Applying hybrid 88-color scheme..."

    # Write tmux.conf for 88-color mode
    cat <<EOF > "$TMUX_CONF"
# XTide86: Hybrid 88-color scheme
set -g default-terminal "xterm-88color"
set -sa terminal-overrides ",xterm-88color*:colors=88"
set -g mouse on
EOF

    echo "[XTide86] Hybrid 88-color config applied."
    ;;
  --color|-c)
    IS_NO_COLOR=""
    echo "[>>>XTide86] Enabling full neon 256-color mode..."

    [ -s "$TMUX_CONF" ] && cp "$TMUX_CONF" "$TMUX_CONF.bak"

    # Write tmux.conf for 256-color mode
    cat <<EOF > "$TMUX_CONF"
# XTide86: Full neon 256-color mode
set -g default-terminal "tmux-256color"
set -sa terminal-overrides ",*:Tc"
set -g mouse on
EOF

    echo "[XTide86] Applied full neon 256-color config."
    ;;
  --update)
    echo "[XTide86] Updating script from GitHub..."

    # Check if git is installed
    if ! command -v git >/dev/null 2>&1; then
      echo "[XTide86] Error: git not installed. Please install git."
      exit 1
    fi

    # Check if in a git repository
    if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
      echo "[XTide86] Error: Not in a git repository. Please run from the XTide86 repo clone."
      exit 1
    fi

    # Get current branch
    CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

    # Pull latest changes
    if git pull origin "$CURRENT_BRANCH" --rebase; then
      echo "[XTide86] Successfully pulled latest changes from GitHub."

      # Path to the script in the repo
      SCRIPT_NAME="xtide86.sh"
      if [ ! -f "$SCRIPT_NAME" ]; then
        echo "[XTide86] Error: $SCRIPT_NAME not found in repository."
        exit 1
      fi

      # Destination for installation
      INSTALL_PATH="/usr/local/bin/xtide86"

      # Copy updated script to /usr/local/bin with sudo
      if sudo cp "$SCRIPT_NAME" "$INSTALL_PATH"; then
        # Make it executable
        if sudo chmod +x "$INSTALL_PATH"; then
          echo "[XTide86] Script updated and installed to $INSTALL_PATH."
        else
          echo "[XTide86] Error: Failed to make $INSTALL_PATH executable."
          exit 1
        fi
      else
        echo "[XTide86] Error: Failed to copy $SCRIPT_NAME to $INSTALL_PATH. Check sudo permissions."
        exit 1
      fi
    else
      echo "[XTide86] Error: Failed to pull changes. Check for merge conflicts or connectivity."
      exit 1
    fi

    exit 0
    ;;
  *)
    IS_NO_COLOR=true
    echo "[XTide86] No flag provided, applying default hybrid 88-color scheme..."

    # Write tmux.conf for default 88-color mode
    cat <<EOF > "$TMUX_CONF"
# XTide86: Default hybrid 88-color scheme
set -g default-terminal "xterm-88color"
set -sa terminal-overrides ",xterm-88color*:colors=88"
set -g mouse on
EOF

    echo "[XTide86] Applied default hybrid 88-color config."
    ;;
esac

# Shift remaining args (do this only once!)
(( $# )) && shift

# === Apply environment variables *after* flag handling ===
if [ -z "$IS_NO_COLOR" ]; then
  export TERM="xterm-256color"
  export COLORTERM=truecolor
  unset NVIM_NO_COLOR  # Use 256-color Neovim scheme
else
  export TERM="xterm-88color"  # 88-color palette
  unset COLORTERM              # Disable truecolor
  export NVIM_NO_COLOR=1       # Use 88-color Neovim scheme (desert)
fi

# Ensure mouse support is enabled in user's tmux.conf
if [ -s "$TMUX_CONF" ]; then
  if ! grep -q "set -g mouse on" "$TMUX_CONF"; then
    echo "set -g mouse on" >> "$TMUX_CONF"
    echo "[XTide86] Enabled mouse support in ~/.tmux.conf"
  fi
else
  echo "set -g mouse on" > "$TMUX_CONF"
  echo "[XTide86] Created ~/.tmux.conf with mouse support"
fi

# Start tmux session only if it doesn't exist
if ! tmux has-session -t xtide86 2>/dev/null; then
  tmux new-session -d -s xtide86
  tmux split-window -h
  tmux send-keys -t xtide86:0.0 'nvim' C-m
  tmux send-keys -t xtide86:0.1 'nvim' C-m

  # Keybindings
  tmux unbind C-b
  tmux set-option -g prefix C-q
  tmux bind-key C-q send-prefix
  tmux bind-key -n C-a resize-pane -R 999 \; select-pane -t 1
  tmux bind-key -n C-d resize-pane -L 999 \; select-pane -t 0
  tmux bind-key -n C-s resize-pane -x 50%
fi

tmux attach-session -t xtide86
